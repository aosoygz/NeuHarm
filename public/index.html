<!DOCTYPE html>
<html>
<head>
  <title>风鸣界 | AI音乐共创平台</title>
  
  <!-- Magenta音乐生成库 -->
  <script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.0.0"></script>
  
  <style>
    /* 保持原有样式不变 */
  </style>
  
  <script>
    // ===== 访问控制 =====
    const ACCESS_PASSWORD = "2024test";
    const ADMIN_IPS = [];
    
    function checkAccess() {
      const passwordInput = sessionStorage.getItem('access_granted') || 
                           prompt("测试阶段，请输入访问密码：");
      
      if (passwordInput === ACCESS_PASSWORD) {
        sessionStorage.setItem('access_granted', 'true');
        return true;
      }
      
      fetch('https://api.ipify.org?format=json')
        .then(res => res.json())
        .then(data => {
          if (ADMIN_IPS.includes(data.ip)) return true;
        });
      
      document.body.innerHTML = `
        <div style="text-align:center;padding:50px">
          <h1>测试阶段，暂不开放</h1>
          <p>请联系管理员获取访问权限</p>
          <button onclick="location.reload()">重新尝试</button>
        </div>
      `;
      return false;
    }
    
    let musicVAE;
    let isModelLoaded = false;
    let modelTimeout;
    
    if (checkAccess()) {
      function initMusicGenerator() {
        // 使用更小的模型
        const modelUrl = 'https://storage.googleapis.com/download.magenta.tensorflow.org/models/music_vae/mel_small';
        
        musicVAE = new mm.MusicVAE(modelUrl);
        document.getElementById('model-info').textContent = `使用模型: ${modelUrl.split('/').pop()}`;
        
        // 显示进度容器
        document.getElementById('progress-container').style.display = 'block';
        
        // 设置超时（8分钟）
        modelTimeout = setTimeout(() => {
          if (!isModelLoaded) {
            document.getElementById('model-status').innerHTML = `
              <div style="color:#d32f2f; margin:15px 0;">
                ❌ 模型加载超时！建议：
                <ul style="text-align:left; margin-top:10px;">
                  <li>刷新页面重试</li>
                  <li>使用更稳定的网络</li>
                  <li>尝试其他浏览器（推荐Chrome）</li>
                  <li><button onclick="window.location.reload()" style="margin-top:10px; padding:8px 20px; background:#d32f2f; color:white; border:none; border-radius:4px; cursor:pointer;">重新加载</button></li>
                </ul>
              </div>
            `;
          }
        }, 8 * 60 * 1000);
        
        // 添加进度监控
        let lastLoaded = 0;
        let lastTime = Date.now();
        
        musicVAE.initialize({
          progress: (loaded, total) => {
            const progressEl = document.getElementById('progress-bar');
            const textEl = document.getElementById('progress-text');
            const speedEl = document.getElementById('speed-text');
            
            const percent = Math.floor((loaded / total) * 100);
            progressEl.style.width = `${percent}%`;
            textEl.textContent = `正在下载模型: ${percent}%`;
            
            // 计算下载速度
            const now = Date.now();
            const elapsed = (now - lastTime) / 1000;
            const loadedDiff = loaded - lastLoaded;
            
            if (elapsed > 0.5) {
              const speed = (loadedDiff / elapsed / 1024).toFixed(1);
              speedEl.textContent = `速度: ${speed} KB/s`;
              lastLoaded = loaded;
              lastTime = now;
            }
          }
        }).then(() => {
          clearTimeout(modelTimeout);
          isModelLoaded = true;
          document.getElementById('model-status').innerHTML = `
            <div style="display:inline-block;width:12px;height:12px;background:green;border-radius:50%;margin-right:5px;"></div> 
            ✅ AI模型已加载完成
          `;
          document.getElementById('control-panel').style.display = 'block';
          document.getElementById('progress-container').style.display = 'none';
        }).catch(error => {
          clearTimeout(modelTimeout);
          console.error('模型加载失败:', error);
          document.getElementById('model-status').innerHTML = `
            <div style="display:inline-block;width:12px;height:12px;background:red;border-radius:50%;margin-right:5px;"></div> 
            ❌ 模型加载失败: ${error.message || '未知错误'}
          `;
        });
      }
      
      initMusicGenerator();
      
      // ...保留原有的generateMusic函数...
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>风鸣界 · 音乐宇宙</h1>
    <p>AI音乐引擎已就绪，定制您的专属旋律</p>
    
    <!-- 模型状态指示器 -->
    <div id="model-status">
      <div style="display:inline-block; width:16px; height:16px; border:3px solid #ccc; border-top-color:#8c1d40; border-radius:50%; margin-right:10px; animation: spin 1s linear infinite;"></div>
      正在加载AI模型...（首次加载可能需要几分钟）
      <div id="model-info" style="font-size:12px; margin-top:5px; color:#666;"></div>
    </div>
    
    <!-- 加载进度条 -->
    <div id="progress-container" style="display:none; margin:20px 0;">
      <div style="display:flex; justify-content:space-between; font-size:14px;">
        <span id="progress-text">正在下载模型: 0%</span>
        <span id="speed-text">速度: 0 KB/s</span>
      </div>
      <div style="height:10px; background:#e0e0e0; border-radius:5px; margin-top:5px;">
        <div id="progress-bar" style="height:100%; width:0%; background:#8c1d40; border-radius:5px; transition:width 0.3s;"></div>
      </div>
    </div>
    
    <!-- 控制面板 -->
    <div id="control-panel" style="display:none;">
      <!-- 保留原有控制面板内容 -->
    </div>
    
    <div class="footer">
      技术支持: NeuHarm · 让每个灵魂自由鸣响
    </div>
  </div>
</body>
</html>
